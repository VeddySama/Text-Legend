name: Generate Android Keystore

on:
  workflow_dispatch:
    inputs:
      key_alias:
        description: "Key alias"
        required: false
        default: "moyu-release"
      store_password:
        description: "Keystore password (leave blank to auto-generate)"
        required: false
      key_password:
        description: "Key password (leave blank to auto-generate)"
        required: false

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Generate keystore
        id: gen
        shell: bash
        run: |
          ALIAS="${{ inputs.key_alias }}"
          STORE_PASS="${{ inputs.store_password }}"
          KEY_PASS="${{ inputs.key_password }}"
          if [ -z "$STORE_PASS" ]; then STORE_PASS=$(openssl rand -hex 16); fi
          if [ -z "$KEY_PASS" ]; then KEY_PASS=$(openssl rand -hex 16); fi
          keytool -genkeypair -v \
            -keystore release.keystore \
            -storepass "$STORE_PASS" \
            -keypass "$KEY_PASS" \
            -alias "$ALIAS" \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -dname "CN=MoyuGame, OU=Dev, O=Moyu, L=Shenzhen, ST=GD, C=CN"
          echo "$STORE_PASS" > store_password.txt
          echo "$KEY_PASS" > key_password.txt
          echo "$ALIAS" > key_alias.txt
          base64 -w 0 release.keystore > keystore_base64.txt

      - name: Upload keystore artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-keystore
          path: |
            release.keystore
            keystore_base64.txt
            store_password.txt
            key_password.txt
            key_alias.txt
